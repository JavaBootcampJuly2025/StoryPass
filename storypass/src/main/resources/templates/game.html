<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Game Room</title>
    <link rel="stylesheet" href="/css/style.css" />
</head>
<body>
<div class="card">
    <h1>Game Room</h1>
    <div>
        <p><strong>Last line:</strong> <span id="last-line">Loading...</span></p>
        <p><strong>Current player:</strong> <span id="current-player">Loading...</span></p>
        <p><strong>Time left:</strong> <span id="time-left">--</span> seconds</p>
        <p><strong>Status:</strong> <span id="game-status">--</span></p>
    </div>

    <div id="turn-section" style="display:none;">
        <textarea id="turn-text" rows="3" cols="50" placeholder="Write your turn here..."></textarea><br />
        <button id="submit-turn-btn">Submit Turn</button>
    </div>

    <button onclick="leaveRoom()">Leave Room</button>
</div>

<script th:inline="javascript">
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login.html';
    }

    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');
    if (!roomId) {
        alert('No room ID specified.');
        window.location.href = '/lobby';
    }

    // We'll store the logged-in user's nickname here once fetched
    let currentUserNickname = null;

    // Fetch logged-in user's info (login & nickname) from /api/me
    async function fetchCurrentUser() {
        try {
            const res = await fetch('/api/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!res.ok) {
                throw new Error('Failed to fetch user info');
            }
            const data = await res.json();
            currentUserNickname = data.nickname;
        } catch (e) {
            console.error(e);
            alert('Error fetching user info. Please login again.');
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        }
    }

    document.getElementById('submit-turn-btn').addEventListener('click', submitTurn);

    async function fetchGameState() {
        try {
            const res = await fetch(`/api/rooms/${roomId}/state`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (res.status === 401) {
                alert('Unauthorized. Please login again.');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }

            if (!res.ok) {
                alert('Failed to load game state.');
                return;
            }

            const state = await res.json();
            updateGameStateUI(state);
        } catch (e) {
            console.error(e);
            alert('Error loading game state.');
        }
    }

    function updateGameStateUI(state) {
        document.getElementById('last-line').textContent = state.lastLine || '(No lines yet)';
        document.getElementById('current-player').textContent = state.currentPlayerNickname || 'N/A';
        document.getElementById('time-left').textContent = state.timeLeftSeconds ?? '--';
        document.getElementById('game-status').textContent = state.status || 'UNKNOWN';

        const isMyTurn = currentUserNickname === state.currentPlayerNickname;
        const gameInProgress = state.status === 'IN_PROGRESS';
        const isOwner = currentUserNickname === state.ownerNickname;

        document.getElementById('turn-section').style.display = (isMyTurn && gameInProgress) ? 'block' : 'none';

        if (!isMyTurn) {
            document.getElementById('turn-text').value = '';
        }

        if (state.status === 'WAITING_FOR_PLAYERS' && isOwner) {
            showStartGameButton();
        } else {
            removeStartGameButton();
        }
    }

    async function submitTurn() {
        const text = document.getElementById('turn-text').value.trim();
        if (!text) {
            alert('Please enter some text.');
            return;
        }

        try {
            const res = await fetch(`/api/rooms/${roomId}/turn`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ text })
            });

            if (res.status === 401) {
                alert('Unauthorized. Please login again.');
                localStorage.removeItem('token');
                window.location.href = '/login.html';
                return;
            }

            if (!res.ok) {
                const err = await res.json();
                alert('Failed to submit turn: ' + (err.message || res.statusText));
                return;
            }

            document.getElementById('turn-text').value = '';
            fetchGameState();
        } catch (e) {
            console.error(e);
            alert('Error submitting turn.');
        }
    }

    async function leaveRoom() {
        if (!confirm('Are you sure you want to leave the room?')) return;

        try {
            const res = await fetch(`/api/rooms/${roomId}/leave`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                alert('Failed to leave the room.');
                return;
            }

            window.location.href = '/lobby';
        } catch (e) {
            console.error(e);
            alert('Error leaving room.');
        }
    }

    function showStartGameButton() {
        if (document.getElementById('start-game-btn')) return;

        const btn = document.createElement('button');
        btn.textContent = 'Start Game';
        btn.id = 'start-game-btn';
        btn.onclick = () => startGame(roomId);
        document.querySelector('.card').appendChild(btn);
    }

    function removeStartGameButton() {
        const btn = document.getElementById('start-game-btn');
        if (btn) btn.remove();
    }

    async function startGame(roomId) {
        try {
            const res = await fetch(`/api/rooms/${roomId}/start`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
                const err = await res.json();
                alert('Failed to start game: ' + (err.message || res.statusText));
                return;
            }

            alert('Game started!');
            removeStartGameButton();
            fetchGameState();
        } catch (e) {
            alert('Error starting game.');
            console.error(e);
        }
    }

    // On page load: first fetch user info, then start polling game state
    (async function init() {
        await fetchCurrentUser();
        await fetchGameState();
        setInterval(fetchGameState, 3000);
    })();
</script>

</body>
</html>
